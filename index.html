<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ˜“ç¶“å¤§å¸«</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --gold: #d4af37; --text: #e0e0e0; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; text-align: center; }
        .container { max-width: 450px; margin: 0 auto; background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        
        /* Hexagram */
        .stage { height: 180px; display: flex; flex-direction: column-reverse; align-items: center; margin: 20px 0; border: 1px dashed #333; justify-content: center;}
        .line { width: 140px; height: 16px; margin: 4px 0; display: flex; justify-content: space-between; align-items: center; }
        .yang { background: var(--gold); width: 100%; }
        .yin::before, .yin::after { content: ''; width: 44%; height: 100%; background: #555; display: block; }
        .old-yang { background: var(--gold); width: 100%; animation: flash 1s infinite; }
        .old-yin::before, .old-yin::after { content: ''; width: 44%; height: 100%; background: #555; animation: flash 1s infinite; }
        @keyframes flash { 50% { opacity: 0.5; } }

        /* Input & Buttons */
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; box-sizing: border-box; }
        button { background: var(--gold); color: #000; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 5px; }
        button:disabled { background: #444; color: #888; }
        .secondary-btn { background: transparent; border: 1px solid #555; color: #aaa; margin-top: 10px; }

        /* API Settings */
        .settings-panel { display: none; text-align: left; background: #252525; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #444; }
        .settings-panel.show { display: block; }
        
        /* Result */
        #aiResult { text-align: left; margin-top: 20px; white-space: pre-wrap; line-height: 1.6; color: #ccc; font-size: 15px; display: none; }
        .loading { color: var(--gold); font-style: italic; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="color:var(--gold); margin:0;">AI æ˜“ç¶“å¤§å¸«</h2>
        <button onclick="toggleSettings()" style="width:auto; padding:5px 10px; font-size:12px; background:#333; color:#fff;">âš™ï¸ è¨­å®š Key</button>
    </div>

    <!-- API Settings -->
    <div id="settingsPanel" class="settings-panel">
        <label style="font-size:12px; color:#aaa;">è¼¸å…¥ä½ çš„ API Key (æ¨è–¦ Perplexity):</label>
        <input type="password" id="apiKey" placeholder="pplx-xxxxxxxx æˆ– sk-xxxxxxxx">
        <div style="font-size:11px; color:#666; margin-bottom:10px;">
            * Key åªæœƒå„²å­˜åœ¨ä½ çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³ä¼ºæœå™¨ã€‚<br>
            * æ¨è–¦ç”³è«‹ <a href="https://www.perplexity.ai/settings/api" target="_blank" style="color:#888;">Perplexity API</a> ä»¥ç²å¾—æœ€æ–°è¯ç¶²è³‡è¨Šã€‚
        </div>
        <button onclick="saveKey()">å„²å­˜é‡‘é‘°</button>
    </div>

    <!-- User Question -->
    <textarea id="userQuestion" rows="2" placeholder="è«‹è¼¸å…¥ä½ æƒ³å•çš„å•é¡Œ (ä¾‹å¦‚ï¼šä¸‹é€±é©åˆè²·é€²å°ç©é›»å—ï¼Ÿ)"></textarea>

    <!-- Divination Area -->
    <div class="stage" id="stage"></div>
    <div style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;">
        <div class="coin">?</div><div class="coin">?</div><div class="coin">?</div>
    </div>
    
    <button id="tossBtn" onclick="toss()">é–‹å§‹æ“²å¦ (0/6)</button>

    <!-- AI Result -->
    <div id="aiResultArea">
        <div class="loading" id="loadingText">ğŸ”® AI å¤§å¸«æ­£åœ¨é€£ç·šè§£è®€ä¸­...</div>
        <div id="aiResult"></div>
        <button id="aiBtn" onclick="askAI()" style="display:none; background:#2a9d8f; color:#fff;">âœ¨ è«‹ AI å¤§å¸«è§£å¦</button>
    </div>
    
    <button class="secondary-btn" onclick="reset()">é‡æ–°é–‹å§‹</button>
</div>

<script>
    // State
    let tossCount = 0;
    let lines = [];
    let hexagramName = "";
    
    // Load Key
    window.onload = () => {
        const key = localStorage.getItem('my_ai_key');
        if(key) document.getElementById('apiKey').value = key;
    };

    function toggleSettings() {
        document.getElementById('settingsPanel').classList.toggle('show');
    }

    function saveKey() {
        const key = document.getElementById('apiKey').value.trim();
        if(!key) return alert('è«‹è¼¸å…¥ API Key');
        localStorage.setItem('my_ai_key', key);
        alert('é‡‘é‘°å·²å„²å­˜ï¼');
        toggleSettings();
    }

    // Hexagram Logic (Simplified for brevity)
    const guaMap = { "111111": "ä¹¾ç‚ºå¤©", "000000": "å¤ç‚ºåœ°", "101010": "æ°´ç«æ—¢æ¿Ÿ", "010101": "ç«æ°´æœªæ¿Ÿ" }; // ... (å®Œæ•´64å¦è«‹ä¿ç•™ä¹‹å‰çš„è³‡æ–™)
    
    function toss() {
        if(tossCount >= 6) return;
        const sum = Math.floor(Math.random() * 2) + Math.floor(Math.random() * 2) + Math.floor(Math.random() * 2) + 6; // 6,7,8,9
        
        // Animation simulation
        setTimeout(() => {
            lines.push(sum);
            renderLine(sum);
            tossCount++;
            document.getElementById('tossBtn').innerText = `æ“²å¦ (${tossCount}/6)`;
            
            if(tossCount === 6) {
                document.getElementById('tossBtn').style.display = 'none';
                document.getElementById('aiBtn').style.display = 'block';
                // Calculate basic hexagram
                let binary = lines.map(v => (v===7||v===9)?'1':'0').join('');
                hexagramName = guaMap[binary] || "æœªçŸ¥åå¦è±¡"; // You can paste the full list from previous code here
                document.getElementById('stage').innerHTML += `<div style='margin-top:10px; color:#d4af37'>å¦è±¡ï¼š${hexagramName}</div>`;
            }
        }, 500);
    }

    function renderLine(val) {
        const div = document.createElement('div');
        div.className = 'line';
        if(val===6) div.innerHTML = "<div class='yin old-yin'></div>";
        if(val===7) div.innerHTML = "<div class='yang'></div>";
        if(val===8) div.innerHTML = "<div class='yin'></div>";
        if(val===9) div.innerHTML = "<div class='yang old-yang'></div>";
        document.getElementById('stage').prepend(div);
    }

    // AI API Call
    async function askAI() {
        const key = localStorage.getItem('my_ai_key');
        const question = document.getElementById('userQuestion').value || "æˆ‘çš„é‹å‹¢å¦‚ä½•ï¼Ÿ";
        
        if(!key) {
            alert("è«‹å…ˆé»æ“Šå³ä¸Šè§’ã€Œè¨­å®š Keyã€è¼¸å…¥ API é‡‘é‘°ï¼");
            toggleSettings();
            return;
        }

        document.getElementById('aiBtn').style.display = 'none';
        document.getElementById('loadingText').style.display = 'block';
        document.getElementById('aiResult').style.display = 'none';

        // Prompt Engineering
        const lineDesc = lines.map((v,i) => `ç¬¬${i+1}çˆ»:${v}(${v===6||v===9?'å‹•çˆ»':'éœçˆ»'})`).join(', ');
        const prompt = `æˆ‘æ­£åœ¨åœå¦å•äº‹ã€‚
        å•é¡Œï¼š${question}
        åœå‡ºçš„å¦è±¡æ˜¯ï¼š${hexagramName} (ç”±ä¸‹è€Œä¸Šæ•¸å€¼: ${lines.join(',')})ã€‚
        è«‹æ‰®æ¼”ä¸€ä½ç²¾é€šæ˜“ç¶“èˆ‡ç¾ä»£å±€å‹¢çš„å¤§å¸«ï¼Œçµåˆã€Œ${hexagramName}ã€çš„å¦ç¾©ï¼Œä»¥åŠç•¶å‰çš„ç¶²è·¯è³‡è¨Šï¼ˆå¦‚æœæ˜¯æ™‚äº‹å•é¡Œï¼‰ï¼Œç‚ºæˆ‘é€²è¡Œè§£è®€ã€‚
        è«‹ç”¨ç™½è©±æ–‡ï¼Œé¢¨æ ¼è¦ªåˆ‡ä½†å°ˆæ¥­ï¼Œä¸¦é‡å°æˆ‘çš„å•é¡Œçµ¦å‡ºå…·é«”å»ºè­°ã€‚`;

        try {
            // Determine API Endpoint (Default to Perplexity, fallback to OpenAI format)
            const isPerplexity = key.startsWith('pplx');
            const url = isPerplexity ? 'https://api.perplexity.ai/chat/completions' : 'https://api.openai.com/v1/chat/completions';
            const model = isPerplexity ? 'sonar-pro' : 'gpt-4o-mini';

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{role: "user", content: prompt}],
                    max_tokens: 1000
                })
            });

            const data = await response.json();
            
            if(data.error) throw new Error(data.error.message);
            
            const aiText = data.choices[0].message.content;
            document.getElementById('aiResult').innerText = aiText;
            document.getElementById('aiResult').style.display = 'block';

        } catch (e) {
            alert("é€£ç·šå¤±æ•—ï¼š" + e.message);
            document.getElementById('aiBtn').style.display = 'block';
        } finally {
            document.getElementById('loadingText').style.display = 'none';
        }
    }

    function reset() {
        location.reload();
    }
</script>

</body>
</html>
